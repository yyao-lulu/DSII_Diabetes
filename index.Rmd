---
title: "Data Science 2 Final Project"
author: "Yangwei Yan (yy2828), Yunqiu Yao (yy2827), Boxuan Li (bl2689)"
date: "4/18/2018"
output: 
  html_document:
    code_folding: hide
---

```{r R set-up, include=FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.asp = 1,
  out.width = "90%"
)

library(MASS)
library(tidyverse)
library(janitor)

theme_set(theme_bw())
theme_update(legend.position = "bottom")
```

```{r dataset cleaning and manipulation}
diabetes <- read_csv('./data/diabetic_data.csv') %>%
  clean_names()


# missing value proportion
diabetes[diabetes=="?"] = NA
sapply(diabetes,function(x) sum(is.na(x))/dim(diabetes)[1]) %>% .[.!=0]

# Therefore, we consider to omit those variables with large number of missing values, i.e., 'weight', 'payer code' and 'medical specialty'. We further omit NA values in other variables.
diabetes <- diabetes %>%
  select(., everything(), -weight, -payer_code, -medical_specialty) %>%
  na.omit() %>%
  arrange(patient_nbr) %>% 
  group_by(patient_nbr) %>% 
  filter(row_number(encounter_id)==1,
         !(discharge_disposition_id %in% c(11,13,14,19:21))) %>% 
# Classify the readmitted status into “Yes” if the patient was readmitted in less than 30 days and “No” if the patient was readmitted in more than 30 days or no record of readmission. 
  mutate(readmitted=ifelse(readmitted=="Yes","<30","No"))
# Specify the variable "Diagnosis" as the correspnding diagnosed diseases
diabetes_tidy = diabetes %>% 
  mutate(
    diag_1=ifelse(diag_1>=390 & diag_1 <= 459 | diag_1 == 785, "Circulatory", 
                  ifelse(diag_1>=460 & diag_1 <= 519 | diag_1 == 786, "Respiratory", 
                  ifelse(diag_1>=520 & diag_1 <= 579 | diag_1 == 787, "Digestive",
                  ifelse(substr(diag_1, 1, 3) == 250, "Diabetes", 
                  ifelse(diag_1>=800 & diag_1 <= 999, "Injury",
                  ifelse(diag_1>=710 & diag_1 <= 739, "Musculoskeletal",
                  ifelse(diag_1>=580 & diag_1 <= 629 | diag_1 == 788, "Genitourinary",
                  ifelse(diag_1>=140 & diag_1 <= 239, "Neoplasms", "Other")))))))),
    diag_2=ifelse(diag_2>=390 & diag_2 <= 459 | diag_2 == 785, "Circulatory", 
                  ifelse(diag_2>=460 & diag_2 <= 519 | diag_2 == 786, "Respiratory", 
                  ifelse(diag_2>=520 & diag_2 <= 579 | diag_2 == 787, "Digestive",
                  ifelse(substr(diag_2, 1, 3) == 250, "Diabetes", 
                  ifelse(diag_2>=800 & diag_2 <= 999, "Injury",
                  ifelse(diag_2>=710 & diag_2 <= 739, "Musculoskeletal",
                  ifelse(diag_2>=580 & diag_2 <= 629 | diag_2 == 788, "Genitourinary",
                  ifelse(diag_2>=140 & diag_2 <= 239, "Neoplasms", "Other")))))))),
    diag_3=ifelse(diag_3>=390 & diag_3 <= 459 | diag_3 == 785, "Circulatory", 
                  ifelse(diag_3>=460 & diag_3 <= 519 | diag_3 == 786, "Respiratory", 
                  ifelse(diag_3>=520 & diag_3 <= 579 | diag_3 == 787, "Digestive",
                  ifelse(substr(diag_3, 1, 3) == 250, "Diabetes", 
                  ifelse(diag_3>=800 & diag_3 <= 999, "Injury",
                  ifelse(diag_3>=710 & diag_3 <= 739, "Musculoskeletal",
                  ifelse(diag_3>=580 & diag_3 <= 629 | diag_3 == 788, "Genitourinary",
                  ifelse(diag_3>=140 & diag_3 <= 239, "Neoplasms", "Other")))))))),
  ) 
diabetes_tidy = diabetes_tidy %>% 
  mutate(
    discharge = ifelse(discharge_disposition_id==1, "Home", "Other"),
    admission_source = ifelse(admission_source_id==7, "Emergency",
                  ifelse(admission_source_id %in% 1:3, "Referral", "Other"))
  ) %>% 
  select(-admission_type_id, -discharge_disposition_id)


head(diabetes_tidy, 10)

summary(diabetes_tidy) # most of the character variables are not summarized

```

The dataset used in this study was extracted from the Health Facts database (Cerner Corporation, Kansas City, MO), a national data warehouse that collects comprehensive clinical records across hospitals throughout the United States. Information in the dataset was systematically collected from participating institutions electronic medical records. In this case, we focus on the records on "diabetic" encounters. The dataset contains `r nrow(diabetes)` observations and `r ncol(diabetes)` variables after data cleaning. Specifically, it incorporates basic information on each "diabetic" encounter for patients, including several demographic characteristics (i.e., "race", "gender" and "age"), hospital records about diagnosis, medical treatments, and th readmission status for each patient. Most of variables in the dataset are categorical, with two or three categories (e.g., "Yes", "No", "Steady", etc.), indicating whether the patient received some treatments or had some particular features. Information in this dataset can be helpful to evaluate the efficacy of different treatments to reduce the readmission rate of patients due to diabetes. Therefore, the "readmitted" variable is regarded as the main response in the supervised analysis section, which will aim to explore the impact of different treatments to the readmission due to diaebtes. Result of this research is promising to provide some insights in improvement of the diabetes treatment. 

During the data cleaning process, we omitted the variables with too many missing values, i.e., 'weight', 'payer code' and 'medical specialty'. Subsequently, few missing values left in other variables were omiited as well. In addtion, we combine "No" and ">30" categories in the "readmitted" variable into ">30" category because it has been verified by research that it is more likely for a patient to readmit after 30 days due to his or her own healthy issues instead of the treatment. Therefore, only readmission within 30 days after discharge is considered to be associated with the treatment in this case, which is why three categories were combined into two indicating readmission related to treatment and readmission irrelevant to treatment respectively. 


```{r supervised learning}

```


